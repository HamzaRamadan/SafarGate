
# وثيقة الهندسة الفنية: جسر أبل السحري وبنية الـ PWA (ARTA-005)

هذا المستند هو المرجع السيادي الرسمي للبنية التقنية التي تمكن تطبيق "سفريات" من العمل كتطبيق ويب تقدمي (PWA) وإرسال إشعارات دفع (Push Notifications) لأجهزة Apple (iOS).

---

### شجرة الرسم التقني (Technical Architecture Tree)

هذا الرسم يوضح المكونات الأربعة التي تشكل "جسر أبل" وتجربة التطبيق الأصلي.

```
/ (المشروع)
│
├── public/
│   │
│   ├── Manifest.json (1. الهوية الرقمية)
│   │   ├── "display": "standalone" -> (إخفاء شريط المتصفح)
│   │   ├── "start_url": "/"
│   │   └── "icons": [...] -> (أيقونة التطبيق على الشاشة الرئيسية)
│   │
│   └── sw.js (2. المحرك الخلفي الصامت)
│       ├── [الجزء الأول]: Firebase Messaging Service Worker
│       │   ├── يستورد مكتبات Firebase.
│       │   └── onBackgroundMessage() -> (يستلم الإشعار ويعرضه حتى لو التطبيق مغلق)
│       │
│       └── [الجزء الثاني]: Caching Worker
│           ├── addEventListener('install') -> (يخزن الملفات الأساسية)
│           └── addEventListener('fetch') -> (يعترض طلبات الشبكة ليعمل بدون نت)
│
└── src/
    │
    ├── app/layout.tsx (3. نقطة التفعيل)
    │   ├── useEffect() -> navigator.serviceWorker.register('/sw.js')
    │   └── <NotificationSetup /> -> (يستدعي مدير الإشعارات)
    │
    └── lib/notification-manager.ts (4. مدير الأذونات)
        ├── requestPermission() -> (يطلب إذن الإشعارات من المستخدم)
        ├── getToken() -> (يحصل على رمز الجهاز الفريد - FCM Token)
        └── updateDoc() -> (يحفظ الرمز في /users/{userId}/fcmTokens)

```

---

### التحليل الشمولي (Holistic Analysis)

هذه البنية تحقق "الحل السحري" من خلال أربعة مكونات تعمل بتناغم:

#### 1. الهوية الرقمية (`manifest.json`)

*   **الوظيفة:** هذا الملف هو "جواز السفر" الذي يقدمه تطبيقنا للمتصفح ونظام التشغيل. خاصية `"display": "standalone"` هي التي تخبر هاتف المستخدم (خاصة iOS) بفتح التطبيق في نافذة خاصة به بدون شريط URL، مما يعطي إحساس التطبيق الأصلي.
*   **الأهمية:** بدون هذا الملف، لا يمكن للمستخدم "تثبيت" التطبيق على الشاشة الرئيسية، وهو **شرط أساسي** لعمل إشعارات الدفع على أجهزة iOS.

#### 2. المحرك الخلفي الصامت (`sw.js`)

*   **الوظيفة:** هذا هو "الجندي المجهول" الذي يعمل في الخلفية. له مهمتان:
    1.  **استقبال الإشعارات:** يحتوي على كود Firebase Messaging الذي يبقى نشطاً حتى لو أغلق المستخدم المتصفح. عند وصول إشعار من الخادم، هذا الملف هو المسؤول عن عرضه على شاشة الجهاز.
    2.  **العمل بدون إنترنت:** يقوم بتخزين الملفات الأساسية (مثل الأيقونات والصفحة الرئيسية) في ذاكرة التخزين المؤقت (Cache)، مما يسمح للتطبيق بالعمل جزئياً حتى في حالة انقطاع الإنترنت.
*   **الأهمية:** هذا هو قلب البنية التحتية للـ PWA.

#### 3. نقطة التفعيل (`layout.tsx`)

*   **الوظيفة:** هذا هو "المفتاح" الذي يشغل المحرك. عند تحميل التطبيق لأول مرة، يقوم هذا الملف بتسجيل "المحرك الخلفي الصامت" (`sw.js`) لدى المتصفح.
*   **الآلية:** من خلال استدعاء `<NotificationSetup />`، يتم تشغيل "مدير الأذونات" لبدء عملية طلب الإذن من المستخدم.

#### 4. مدير الأذونات (`notification-manager.ts`)

*   **الوظيفة:** هذا هو "الدبلوماسي" الذي يتفاوض مع المستخدم للحصول على إذن إرسال الإشعارات.
*   **الآلية:**
    1.  يطلب من المستخدم الإذن بشكل رسمي عبر نافذة منبثقة من المتصفح.
    2.  إذا وافق المستخدم، يقوم بالتواصل مع خوادم Google/Apple للحصول على "رمز فريد" لهذا الجهاز (FCM Token).
    3.  يقوم بحفظ هذا الرمز في قاعدة البيانات (`fcmTokens` في وثيقة المستخدم)، ليتمكن "المحرك السحابي" لاحقاً من استخدامه لإرسال الإشعارات.

بهذه الهندسة المتكاملة، نضمن أن نظام "سفريات" لا يعمل فقط كتطبيق ويب، بل كتجربة شبه أصلية قادرة على الوصول للمستخدم في أي وقت، حتى على أكثر الأنظمة تشدداً مثل iOS.
