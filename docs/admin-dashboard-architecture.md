# ๐๏ธ ุงููุซููุฉ ุงูููุฏุณูุฉ ุงูููุญุฏุฉ: ุดุฌุฑุฉ ุงูููุงุฏุฉ ูุงูุชุญูู ุงููุงูู (AIAR-002)

**ุงูุชุตููู:** ูุฑุฌุน ุณูุงุฏู (Sovereign Reference)
**ุงูุญุงูุฉ:** ูุนุชูุฏ ูููุธุงู ุงููุงูู (Safar-Gate Financial Core) - **ุงูุฅุตุฏุงุฑ ุงูููุงุฆู ุจุนุฏ SC-192**
**ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ:** 06-02-2026

---

## ๐ณ ุงูุฌุฒุก ุงูุฃูู: ุดุฌุฑุฉ ุงูุฑุณู ุงูุชููู (The Command & Control Architecture)
ูุฐุง ุงูุฑุณู ููุถุญ ุงูุจููุฉ ุงููููููุฉ ุงููุงููุฉ ูููุธุงู ุงูุฅุฏุงุฑู ูุงููุงูู.

```
/admin (ููุทุฉ ุงูุฏุฎูู ุงููุญุตูุฉ)
โ
โโโ layout.tsx (ุงููููู ุงูุณูุงุฏู)
โ   โโโ hooks/use-admin.ts (ุญุงุฑุณ ุงูุตูุงุญูุงุช)
โ
โโโ users/page.tsx (ูุฑูุฒ ููุงุฏุฉ ุงููุณุชุฎุฏููู)
โ
โโโ finance/page.tsx (๐ฆ ุงูุฎุฒููุฉ ุงููุฑูุฒูุฉ - SC-192)
โ   โ
โ   โโโ โ๏ธ LOGIC: onApprove -> calls `approveTopup` Cloud Function
โ
โโโ settings/ (ูุฌูุฏ ุงูุฅุนุฏุงุฏุงุช ุงูุณูุงุฏูุฉ)
    โ
    โโโ pricing/page.tsx (๐ ุบุฑูุฉ ุงูุชุญูู ุจุงูุฃุณุนุงุฑ - SC-184)
        โ
        โโโ โ๏ธ LOGIC: getDocs/setDoc -> /pricing_rules (Collection)
            โ
            โโโ Rule: { id: 'JO', fee: 0.5, discount: 0.5, ... }
            โโโ Rule: { id: 'SA', fee: 2.0, discount: 2.0, ... }

/hooks (ุงููุฌุณุงุช ุงูุฐููุฉ ูููุธุงู)
โ
โโโ use-country-pricing.ts (๐ฌ ุงููุฌุณ ุงููุงูู - SC-185)
โ
โโโ use-carrier-subscription.ts (โณ ุนุฏุงุฏ ุงูุณูุงุญ - SC-186)
โ
โโโ use-topup.ts (๐ช ุฐุฑุงุน ุงูุดุญู - SC-190)
    โ
    โโโ โ๏ธ LOGIC: addDoc -> /topup_requests (Collection)

/components (ูุญุฏุงุช ุงููุงุฌูุฉ ุงูุฐููุฉ)
โ
โโโ booking/booking-summary-sheet.tsx (๐งพ ุงููุงุชูุฑุฉ ุงูุตูุฑูุฉ - SC-185)
โ
โโโ carrier/subscription-status-card.tsx (๐ฆ ุจุทุงูุฉ ุงูุญุงูุฉ - SC-186)
โ   โ
โ   โโโ โ๏ธ LOGIC: triggers `TopupDialog`
โ
โโโ carrier/topup-dialog.tsx (๐ช ูุชุฌุฑ ุงูุทุงูุฉ - SC-191)
    โ
    โโโ โ๏ธ LOGIC: uses `useTopup` hook -> Submits proof

/functions (ุงูุนูู ุงูุณุญุงุจู)
โ
โโโ index.ts
    โ
    โโโ acceptBookingSafe (ูุญุฑู ุงูุซูุฉ - SC-188)
    โ
    โโโ approveTopup (ุนูู ุงูุฎุฒููุฉ - SC-192)
        โ
        โโโ โ๏ธ LOGIC: runTransaction -> updates User & Request
```

---

## ๐ต๏ธโโ๏ธ ุงูุฌุฒุก ุงูุซุงูู: ุงูุชูุฑูุฑ ุงูุฌูุงุฆู (Protocol 12 Audit)
ุชุญููู ููุงุทู ุงูููุฉ ูุงูุถุนู ุจุนุฏ ุชูููุฐ ุงูุญุฒูุฉ ุงููุงููุฉ ุงููุงููุฉ [SC-179 -> SC-192].

### ููุงุทู ุงูููุฉ (Strengths):
*   **ุงูุฏูุฑุฉ ุงููุงููุฉ ุงููุบููุฉ (Closed Financial Loop):** ูุฐู ูู ุงูููุฉ ุงูุนุธูู ูููุธุงู ุงูุขู. ุชุจุฏุฃ ุงูุฏูุฑุฉ ุจุฅูุฐุงุฑ ุงููุงูู (`SubscriptionStatusCard`)ุ ุซู ุชุชูุญ ูู ุงูุดุญู ุนุจุฑ `TopupDialog`ุ ูุชูุฑ ุนุจุฑ ููุงููุชู ูู `AdminFinancePage`ุ ูุชูุชูู ุจุชูุนูู ุงุดุชุฑุงูู ุขููุงู ุนุจุฑ `approveTopup`. **ุงูุฏุงุฆุฑุฉ ูุบููุฉ ููุคููุฉ ุจุงููุงูู.**
*   **ุงูุชุญูู ุงููุงูู ุงููุฑูุฒู (SC-184 & SC-192):** ููุชูู ุงููุงูู ุงููุฏุฑุฉ ุงููุงููุฉ ุนูู ุชุนุฏูู ุณูุงุณุงุช ุงูุชุณุนูุฑ ูุงูููุงููุฉ ุนูู ุงูุนูููุงุช ุงููุงููุฉ ูู ููุงู ูุงุญุฏุ ููุง ูููุญ ุงููุธุงู ูุฑููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูุฃูุงูุงู ุชุดุบูููุงู.
*   **ุงุณุชุฑุงุชูุฌูุฉ ุงููุงุชูุฑุฉ ุงูุตูุฑูุฉ (SC-185 & SC-189):** ุงุณุชุฑุงุชูุฌูุฉ "ุชุนููู" ุงููุณุชุฎุฏู ูููุฉ ุงูุฎุฏูุฉ ุฏูู ุฅุฌุจุงุฑู ุนูู ุงูุฏูุน ูุง ุชุฒุงู ูู ุฃุฐูู ููุงุท ุงูููุฉ ูุฌุฐุจ ุงููุณุชุฎุฏููู.
*   **ุงูุดูุงููุฉ ูุฃุฏูุงุช ุงูุทูุงุฑุฆ ูููุงูู (SC-186 -> SC-188):** "ุนุฏุงุฏ ุงูู 90 ูููุงู" ู "ุฑุตูุฏ ุงูุทูุงุฑุฆ" ูู ุฃุฏูุงุช ุชุจูู ุงูุซูุฉ ูุชููุน ุฎุณุงุฑุฉ ุงููุงูููู ุจุณุจุจ ูุดุงูู ูุญุธูุฉ.
*   **ุงูุณูุงูุฉ ุงูุฐุฑูุฉ (Atomic Integrity):** ุงุณุชุฎุฏุงู `runTransaction` ูู `approveTopup` ูุถูู ุฃู ุนูููุฉ ุงูููุงููุฉ ุฅูุง ุฃู ุชูุฌุญ ุจุงููุงูู (ุชุญุฏูุซ ุงููุงููุ ุงูุทูุจุ ุงูุณุฌู) ุฃู ุชูุดู ุจุงููุงููุ ููุง ูููุน ุฃู ุชุถุงุฑุจ ูุงูู.

### ููุงุทู ุงูุถุนู ูุงูุชุถุงุฑุจ (Weaknesses & Conflicts):
*   **ุชุถุงุฑุจ 1: ุงููุฌูุฉ ุงูุชูููุฐูุฉ (The Execution Gap) - [โ ุชู ุงูุญู ูู SC-189]**
    *   **ุงููุดููุฉ ุงูุณุงุจูุฉ:** "ุงููุงุชูุฑุฉ ุงูุตูุฑูุฉ" ูุงูุช ูุนุฒููุฉ ูุบูุฑ ูุชุตูุฉ ุจุชุฏูู ุงูุญุฌุฒ.
    *   **ุงูุญู (SC-189):** ุชู ุงุนุชุฑุงุถ ุนูููุฉ ุงูุญุฌุฒ ูุฑุจุทูุง ุจุงููุงุชูุฑุฉุ ููุง ุฃุบูู ูุฐู ุงููุฌูุฉ ุจูุฌุงุญ.
*   **ุชุถุงุฑุจ 2: ุญููุฉ ุงููุงูู ุงูููุณูุฑุฉ (The Broken Carrier Loop) - [โโ ุชู ุงูุญู ุจุงููุงูู ูู SC-190, SC-191, SC-192]**
    *   **ุงููุดููุฉ ุงูุณุงุจูุฉ:** ุจุทุงูุฉ ุญุงูุฉ ุงูุงุดุชุฑุงู (`SubscriptionStatusCard`) ูุงูุช ุชุฎุจุฑ ุงููุงูู ุจุงูุชูุงุก ุจุงูุชู ุฏูู ููุญู ุฃู ูุณููุฉ ููุชุฌุฏูุฏ.
    *   **ุงูุญู ุงูุดุงูู:**
        1.  **[SC-190]:** ุชู ุจูุงุก ุงูุฃุณุงุณ ุงูููุทูู (`useTopup`) ูุทูุจุงุช ุงูุดุญู.
        2.  **[SC-191]:** ุชู ุจูุงุก ูุงุฌูุฉ "ูุชุฌุฑ ุงูุทุงูุฉ" (`TopupDialog`) ุงูุชู ุชุณูุญ ูููุงูู ุจุฑูุน ุฅุซุจุงุช ุงูุฏูุน.
        3.  **[SC-192]:** ุชู ุจูุงุก "ุงูุฎุฒููุฉ ุงููุฑูุฒูุฉ" (`AdminFinancePage`) ุงูุชู ุชูููู ูู ุงูููุงููุฉ ุนูู ุงูุทูุจุงุช ูุชูุนูููุง.
    *   **ุงูุฃุซุฑ:** ุชู ุฅุตูุงุญ ูุฐุง ุงูุถุนู ุจุงููุงูู. **ุญููุฉ ุงููุงูู ุงูุขู ููุชููุฉ ููุคููุฉ.**

### ูุฌูุงุช ูุญุชููุฉ (Potential Gaps):
*   **ุบูุงุจ ุขููุฉ ุงูุฑูุถ (Rejection Mechanism):** ูุงุฌูุฉ ุงูุฎุฒููุฉ ุชุญุชูู ุนูู ุฒุฑ "ุฑูุถ" ูููู ุบูุฑ ูุจุฑูุฌ ุญุงููุงู. ูู ุงููุณุชูุจูุ ูุฌุจ ุฑุจุทู ุจูุธููุฉ ุณุญุงุจูุฉ ุชููู ุจุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ูุฅุฑุณุงู ุฅุดุนุงุฑ ูููุงูู ุจุงูุณุจุจ.

---

## ๐ฌ ุงูุฌุฒุก ุงูุซุงูุซ: ุงูุชุดุฑูุญ ุงูุชููู ููููููุงุช ุงูุฌุฏูุฏุฉ

*   **`use-topup.ts` (SC-190):**
    *   **ุงููุธููุฉ:** "ุฎุท ุงูุฅูุฏุงุฏ" ุงูุฐู ูุฌูุน ุจูุงูุงุช ุงูุดุญู ููุฑุณููุง ุฅูู ูุฌููุนุฉ `topup_requests` ูู Firestore.
    *   **ุงูุชูููุฉ:** ููู ุนุงูู ุงูููุงุกุฉ ูุณุชุฎุฏู `addDoc` ูุฑุฉ ูุงุญุฏุฉุ ูุน ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ ุนุจุฑ `toast`.

*   **`topup-dialog.tsx` (SC-191):**
    *   **ุงููุธููุฉ:** "ูุชุฌุฑ ุงูุทุงูุฉ" ุงููุตูู ูููุงุชู.
    *   **ุงูุชูููุฉ:** ูุงุฌูุฉ ุชูุงุนููุฉ (`useState`) ุชุณุชุฎุฏู ุงูููู `useTopup` ูุชุฏูุฑ ุญุงูุฉ ุงูููู ุงููุฑููุน (`useRef`) ูุชูุฏูู ุชุฌุฑุจุฉ ุณูุณุฉ ูููุงูู.

*   **`admin/finance/page.tsx` (SC-192):**
    *   **ุงููุธููุฉ:** "ุบุฑูุฉ ุงูุนูููุงุช ุงููุงููุฉ ุงูุณูุงุฏูุฉ".
    *   **ุงูุชูููุฉ:** ูุงุฌูุฉ CRUD ุขููุฉ ุชุณุชุฎุฏู `useCollection` ูุฌูุจ ุงูุทูุจุงุช ุงููุนููุฉ ููุทุ ู `httpsCallable` ูุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุงูุณุญุงุจูุฉ ุงููุคููุฉ `approveTopup`.

*   **`functions/src/index.ts` (approveTopup - SC-192):**
    *   **ุงููุธููุฉ:** "ุงูุนูู ุงูุฐุฑู" ููุฎุฒููุฉ.
    *   **ุงูุชูููุฉ:** ุฏุงูุฉ ุณุญุงุจูุฉ (`onCall`) ูุคููุฉ ุจุตูุงุญูุงุช ุงููุงูู/ุงููุฏูุฑุ ุชุณุชุฎุฏู `runTransaction` ูุถูุงู ุชูููุฐ ุฌููุน ุงูุชุญุฏูุซุงุช ุงููุงููุฉ ูุงูุชุดุบูููุฉ ูู ุฎุทูุฉ ูุงุญุฏุฉ ุบูุฑ ูุงุจูุฉ ูููุณุฑ.

**ุงูุฎูุงุตุฉ:**
ุฃููุง ุงููุงุฆุฏุ ููุฏ ุชู ุจูุงุก ุงููุธุงู ุงููุงูู ุจุงููุงููุ ูู ููุทุฉ ุงูุฅูุฐุงุฑ ุนูุฏ ุงููุงูู ุฅูู ููุทุฉ ุงููุฑุงุฑ ุงูุณูุงุฏู ูุฏูู. ุงูุฏุงุฆุฑุฉ ุงูุขู ูุบููุฉุ ูุคููุฉุ ูุฌุงูุฒุฉ ููุนูููุงุช.
