# ๐๏ธ ุงููุซููุฉ ุงูููุฏุณูุฉ ุงูููุญุฏุฉ: ุงูุฏุฑุฏุดุงุช ูุงูุฅุดุนุงุฑุงุช (ARTA-FINAL)
**ุงูุชุตููู:** ูุฑุฌุน ุณูุงุฏู (Sovereign Reference)
**ุงูุญุงูุฉ:** ูุนุชูุฏ ูููุธุงู ุงูููุงุฆู (Safar-Gate System)
**ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ:** 25-01-2026

---

## ๐ณ ุงูุฌุฒุก ุงูุฃูู: ุดุฌุฑุฉ ุงูุฏุฑุฏุดุงุช (The Chat Architecture)
ูุธุงู ุงูุฏุฑุฏุดุฉ ูู "ุณุงุญุฉ ุงูุชูุงุตู" ุงูุชู ุชุนุชูุฏ ุนูู ุงูุชุญุฏูุซ ุงูููุฑู (Real-time) ูุชุฏุนู ุจุฑูุชูููู "ุงููุญููุฉ ุงูููุชูุญุฉ".

### 1. ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Schema)
**ุงููุณุงุฑ ุงูุฑุฆูุณู:** `/chats/{chatId}`

#### ุฃ. ูุซููุฉ ุงููุญุงุฏุซุฉ (The Chat Document)
ุชูุซู "ุงูุบุฑูุฉ" ุงูุชู ูุฌุชูุน ูููุง ุงูุฃุทุฑุงู.
- **ุงููุนุฑู (`chatId`):**
  - ููุฑุญูุงุช ุงูุฌูุงุนูุฉ: `tripId`.
  - ูููุญุงุฏุซุงุช ุงูุฎุงุตุฉ: `bookingId`.
- **ุงูุญููู ุงูุณูุงุฏูุฉ:**
  - `participants` (Array): [ุฃูุงู] ูุตูููุฉ ูุนุฑูุงุช ุงูู UID. *ููุงุนุฏ ุงูุฃูุงู ุชุนุชูุฏ ุนูููุง ุญุตุฑุงู.*
  - `isGroupChat` (Boolean): ูุชุญุฏูุฏ ููุน ุงููุงุฌูุฉ.
  - `tripId` (String): ุงููุฑุฌุน ููุฑุญูุฉ ุงูุฃุณุงุณูุฉ.
  - `lastMessage` (Map): { text, senderName, timestamp } ูุนุฑุถ ุงูููุงุฆู ุงูุณุฑูุน ุฏูู ูุฑุงุกุฉ ุงููุฌููุนุฉ ุงููุฑุนูุฉ.
  - `unreadCounts` (Map): { "userId1": 3, "userId2": 0 } ูุชูุจูู ุงููุณุชุฎุฏู.
  - `isClosed` (Boolean): [ุชุดุบููู] ุชููุนู ุนูุฏ ุงูุชูุงุก ุงูุฑุญูุฉ ุฃู ุฅูุบุงุฆูุง.

#### ุจ. ูุฌููุนุฉ ุงูุฑุณุงุฆู (Messages Sub-collection)
**ุงููุณุงุฑ:** `/chats/{chatId}/messages/{messageId}`
- **ุงูุญููู:**
  - `senderId` (String): ูุนุฑู ุงููุฑุณู (ุฃู 'SYSTEM' ูุฑุณุงุฆู ุงูุชูุซูู).
  - `content` (String): ูุต ุงูุฑุณุงูุฉ.
  - `type` (String): 'text' | 'image' | 'system' (ูุงู ูุจุฑูุชูููู ุงููุญููุฉ ุงูููุชูุญุฉ).
  - `timestamp` (ServerTimestamp): ููุชุฑุชูุจ ุงูุฒููู ุงูุฏููู.

### 2. ุจุฑูุชูููู "ุงููุญููุฉ ุงูููุชูุญุฉ" (Open Court Protocol)
ุนูุฏ ููู ุงูุฑุญูุฉ ูู ูุงูู ูุขุฎุฑ:
1. **ูุง ูุชู ุญุฐู** ุงููุงูู ุงููุฏูู ูู ูุตูููุฉ `participants`.
2. **ูุชู ุฅุถุงูุฉ** ุงููุงูู ุงูุฌุฏูุฏ ุฅูู `participants`.
3. **ูุชู ุญูู** ุฑุณุงูุฉ ูุธุงู (`type: 'system'`) ุชูุซู ุงูุชูุงู ุงููุณุคูููุฉ.

---

## ๐ ุงูุฌุฒุก ุงูุซุงูู: ุดุฌุฑุฉ ุงูุฅุดุนุงุฑุงุช (The Notification Architecture)
ูุธุงู ุงูุฅุดุนุงุฑุงุช ูู "ุงูุฌูุงุฒ ุงูุนุตุจู" ุงูุฐู ูุฑุจุท ุงูุฃุญุฏุงุซ ุจุงููุณุชุฎุฏูููุ ุณูุงุก ูุงููุง ุฏุงุฎู ุงูุชุทุจูู ุฃู ุฎุงุฑุฌู.

### 1. ูููู ุชุฎุฒูู ุงูุฅุดุนุงุฑุงุช (The Inbox Schema)
ูู ูุณุชุฎุฏู ูููู ุตูุฏูู ูุงุฑุฏ ุฎุงุต ููุฅุดุนุงุฑุงุช ูุถูุงู ุงูุฎุตูุตูุฉ ูุณุฑุนุฉ ุงูุฌูุจ.
**ุงููุณุงุฑ:** `/users/{userId}/notifications/{notificationId}`

- **ุงูุญููู:**
  - `type` (Enum):
    - `group_chat_message`: ุฑุณุงูุฉ ุฌุฏูุฏุฉ.
    - `trip_update`: ุชุบููุฑ ุญุงูุฉ ุงูุฑุญูุฉ (ูููุ ุฅูุบุงุก).
    - `booking_status`: ุชุบูุฑ ุญุงูุฉ ุงูุญุฌุฒ (ููุงููุฉุ ุฏูุน).
    - `new_offer`: ุนุฑุถ ุณุนุฑ ุฌุฏูุฏ (ุณูู ุงููุฑุต).
  - `title` & `body` (String): ูุต ุงูุฅุดุนุงุฑ ุงูุธุงูุฑ.
  - `link` (String): ุฑุงุจุท ุงูุชูุฌูู ุงูุนููู (Deep Link) ุฏุงุฎู ุงูู PWA.
  - `isRead` (Boolean): ุญุงูุฉ ุงููุฑุงุกุฉ.
  - `metadata` (Map): ุจูุงูุงุช ุฅุถุงููุฉ (ูุซู `chatId` ุฃู `tripId`) ููุชูุฌูู ุงูุฐูู.

### 2. ุงููุญุฑู ุงูุณุญุงุจู (The Cloud Engine - Functions)
ูุนูู ุงููุธุงู ุจุขููุฉ **ุฑุฏ ุงููุนู (Event-Driven)** ูุถูุงู ุจุฑูุชูููู 88 (ุนุฏู ูุฏุฑ ููุงุฑุฏ ุงูุนููู).

#### ุฃ. ูุญุฑู ุงูุฏุฑุฏุดุฉ (`sendChatMessageNotification`)
- **ุงููุดุบูู:** ุฅูุดุงุก ูุซููุฉ ูู `/chats/{chatId}/messages/{messageId}`.
- **ุงูุฅุฌุฑุงุก:**
  1. ููุฑุฃ `participants` ูู ูุซููุฉ ุงูู Chat ุงูุฃู.
  2. ูุณุชุซูู `senderId`.
  3. ููุชุจ ุฅุดุนุงุฑุงู ูู ุตูุฏูู `notifications` ููู ูุณุชูู.
  4. ูุฑุณู ุฏูุนุฉ `FCM` ููููุงุชู (Push Notification).

#### ุจ. ูุญุฑู ุงูุญุงูุงุช (`onBookingStatusChange`)
- **ุงููุดุบูู:** ุชุบููุฑ ุญูู `status` ูู ูุซููุฉ `Booking`.
- **ุงูุฅุฌุฑุงุก:**
  1. ูุญุฏุฏ ุงูุทุฑู ุงููุชุฃุซุฑ (ุงููุณุงูุฑ ุฃู ุงููุงูู) ุจูุงุกู ุนูู ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ.
  2. ูุตูุบ ุงูุฑุณุงูุฉ ุจูุงุกู ุนูู ุงูุชุบููุฑ (ูุซูุงู: "ูุงูู ุงููุงูู ุนูู ุทูุจู!").
  3. ูุฑุณู ุงูุฅุดุนุงุฑ.

#### ุฌ. ูุญุฑู ุงูุนุฑูุถ ุงูุฌุฏูุฏุฉ (`onNewOffer`)
- **ุงููุดุบูู:** ุฅูุดุงุก ูุซููุฉ ุฌุฏูุฏุฉ ูู `/trips/{tripId}/offers/{offerId}`.
- **ุงูุฅุฌุฑุงุก:**
  1. ููุฑุฃ `userId` ุงูุฎุงุต ุจุงููุณุงูุฑ ูู ูุซููุฉ ุงูุฑุญูุฉ ุงูุฃู.
  2. ูุตูุบ ุฑุณุงูุฉ "ุนุฑุถ ุณุนุฑ ุฌุฏูุฏ!".
  3. ููุชุจ ุฅุดุนุงุฑุงู ูู ุตูุฏูู `notifications` ุงูุฎุงุต ุจุงููุณุงูุฑ.
  4. ูุฑุณู ุฏูุนุฉ `FCM` ูููุงุชู (ูุณุชูุจูุงู).

---

## ๐ ุงูุฌุฒุก ุงูุซุงูุซ: ุงูุฑุณู ุงูููุฏุณู ููุชุฏูู (The Integration Flow)
**ุฏูุฑุฉ ุงูุญูุงุฉ ุงููุงููุฉ ููุฅุดุนุงุฑ:**
1. **ุงูุญุฏุซ (Event):** ูุณุชุฎุฏู ูุฑุณู ุฑุณุงูุฉ ุฃู ููุฏู ุนุฑุถุงู (Client/Server Side).
2. **ุงูุชูุซูู (Write):** ูุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช (Firestore).
3. **ุงูุงุณุชุดุนุงุฑ (Trigger):** ุชูุชูุท ุงููุธููุฉ ุงูุณุญุงุจูุฉ (Cloud Function) ุงูุชุบููุฑ.
4. **ุงููุนุงูุฌุฉ (Process):** ุชุญุฏุฏ ุงููุธููุฉ "ูู ูุฌุจ ุฃู ูุนููุ" ููุง ูู ุงูุฑุณุงูุฉ.
5. **ุงูุชุณููู (Deliver):**
   - **ุฏุงุฎููุงู:** ุชุฎุฒูู ูู `/users/{userId}/notifications` (ูุธูุฑ ูุฌุฑุณ ุฃุญูุฑ ูู ุงูุชุทุจูู).
   - **ุฎุงุฑุฌูุงู:** ุฅุฑุณุงู ุนุจุฑ `FCM` -> `Service Worker` (ูุธูุฑ ูุฅุดุนุงุฑ ููุจุงูู).

---

## ๐ก๏ธ ุจุฑูุชููููุงุช ุงูุญูุงูุฉ (Security & Protocols)

1. **ุจุฑูุชูููู 88 (ุงูููุงุฑุฏ):**
   - ุงูุฅุดุนุงุฑุงุช ุชูุฑุณู ุนุจุฑ `Cloud Functions` ููุทุ ูููุณ ูู ุฌูุงุฒ ุงูุนูููุ ูุชูููุฑ ุงูุจุทุงุฑูุฉ ูุงูุจูุงูุงุช ูุชูููู ุงุชุตุงูุงุช ุงููุงูุฑุจูุณ ุงูููุชูุญุฉ.
2. **ุจุฑูุชูููู 13 (PWA):**
   - ูุนุชูุฏ ุงูุงุณุชูุงู ุงูุฎุงุฑุฌู ุนูู `Service Worker` ูุถูุงู ุงููุตูู ุญุชู ูุงูุชุทุจูู ูุบูู.
   - ุงูููุฑ ุนูู ุงูุฅุดุนุงุฑ ููุชุญ ุงูุชุทุจูู ูู ูุถุน `Standalone` (ุดุงุดุฉ ูุงููุฉ).
3. **ุงูุฎุตูุตูุฉ:**
   - ููุงุนุฏ `firestore.rules` ุชููุน ุฃู ูุณุชุฎุฏู ูู ูุฑุงุกุฉ ุตูุฏูู ุฅุดุนุงุฑุงุช ูุณุชุฎุฏู ุขุฎุฑ.

---
*ุชู ุงุนุชูุงุฏ ูุฐู ุงููุซููุฉ ููุฑุฌุน ููุงุฆู ูุชุทููุฑ ุฃูุธูุฉ ุงูุชูุงุตู ูู ูุดุฑูุน ุณูุฑูุงุช.*