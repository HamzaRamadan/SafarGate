
# ูุซููุฉ ุงูููุฏุณุฉ ุงููููุฉ: ุดุฌุฑุฉ ุณูู ุงููุฑุต (AIAR-008)

ูุฐุง ุงููุณุชูุฏ ูู ุงููุฑุฌุน ุงูุณูุงุฏู ุงูุฑุณูู ุงูุฐู ููุซู ููุญูู ุงูุจููุฉ ุงููููุฉ ูุงููููููุฉ ุงููุงููุฉ ูุณูู ุงููุฑุต (Opportunities Market)ุ ููู ุงููุญุฑู ุงูุงูุชุตุงุฏู ุงูุฃุณุงุณู ูููุงูููู ูู ูุธุงู "ุณูุฑูุงุช".

---

### 1. ุดุฌุฑุฉ ุงูุฑุณู ุงูุชููู (Technical Architecture Tree)

ูุฐุง ุงูุฑุณู ููุถุญ ููู ูุชู ุชุญููู ุงูุจูุงูุงุช ุงูุฎุงู ุฅูู ูุฑุต ุฐููุฉ ููุงุจูุฉ ููุชูููุฐุ ูุน ุชุญุฏูุฏ ุงููููุงุช ุงูุณูุงุฏูุฉ ููู ูุฑุญูุฉ.

```
/carrier/opportunities (ููุทุฉ ุฏุฎูู ุงููุงูู ุฅูู ุงูุณูู)
โ
โโโ page.tsx (ุงูุนูู ุงููุฏุจุฑ ููุณูู - The Market Engine)
    โ
    โโโ ๐ง **ููุทู ุงูุฌูุจ ูุงูุชุญูู (Hooks & State):**
    โ   โโโ `useUserProfile()` -> ูุฌูุจ ุจูุงูุงุช ุงููุงูู (ุงูุงุฎุชุตุงุตุ ุงูุณุนุฉุ ุงูุญุงูุฉ).
    โ   โโโ `useDoc(activeTripRef)` -> ููุฑุงูุจุฉ ุงูุฑุญูุฉ ุงููุดุทุฉ ูุชูุนูู "ููุทู ุงูุนูุฏุฉ".
    โ   โโโ `useCollection(opportunitiesQuery)` -> ูุฌูุจ ุงูุจูุงูุงุช ุงููููุชุฑุฉ ูู Firestore.
    โ
    โโโ โ๏ธ **ูุญุฑู ุงูุงุณุชุนูุงู ุงูุฐูู (The Smart Query Engine): opportunitiesQuery**
    โ   โ   // ูุฐุง ููุณ ุงุณุชุนูุงูุงู ูุงุญุฏุงูุ ุจู ุณูุณูุฉ ูู ุงูููุงุนุฏ ุฐุงุช ุงูุฃููููุฉ
    โ   โ
    โ   โโโ 1. **ุงููููุฏ ุงูุฃุณุงุณูุฉ (Base Constraints):**
    โ   โ   โโโ `status == 'Awaiting-Offers'`
    โ   โ   โโโ `departureDate >= now`
    โ   โ   โโโ `passengers <= myCapacity` (ููุชุฑ ุงูุณุนุฉ - SC-075)
    โ   โ   โโโ `preferredVehicle IN ['any', myCategory]` (ููุชุฑ ุงูุชูุถูู - SC-075)
    โ   โ
    โ   โโโ 2. **ุงูุฃููููุฉ ุงููุตูู: ููุทู ุงูุนูุฏุฉ (Return Trap Fix - SC-071):**
    โ   โ   โโโ IF (ุงููุงูู ูุดุบูู) -> query(..., `origin == activeTrip.destination`, ...baseConstraints)
    โ   โ
    โ   โโโ 3. **ุงูุฃููููุฉ ุงูุซุงููุฉ: ููุชุฑ ุงูุงุฎุชุตุงุต (Jurisdiction Filter):**
    โ   โ   โโโ IF (ุงููุงูู ุบูุฑ ูุดุบูู) -> query(..., `origin IN [myOrigin, myDest]`, ...baseConstraints)
    โ   โ
    โ   โโโ 4. **ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ (Fallback):**
    โ       โโโ query(..., `requestType == 'General'`, ...baseConstraints)
    โ
    โโโ ๐ผ๏ธ **ุทุจูุฉ ุงูุนุฑุถ ุงูุฐููุฉ (Smart Rendering Layer):**
        โโโ ๐ต **ููุญุฉ ุงูุชูุฌูู ุงูุฒุฑูุงุก:** (IF ุงููุงูู ูุดุบูู) -> "ูุนุฑุถ ูู ุฑุญูุงุช ุงูุนูุฏุฉ..."
        โโโ ๐ก **ุฌุฏุงุฑ ุงูุชูุจูู ุงูุฃุตูุฑ:** (IF ุงููุงูู ูู ูููู ูููู) -> "ูุฑุฌู ุชุญุฏูุฏ ุงุฎุชุตุงุตู..."
        โโโ โช **ุดุงุดุฉ ุงููุฑุงุบ ุงูุจูุถุงุก:** (IF ูุง ุชูุฌุฏ ูุชุงุฆุฌ) -> "ูุง ุชูุฌุฏ ูุฑุต ูุทุงุจูุฉ..."
        โโโ โ **ุดุจูุฉ ุงููุชุงุฆุฌ:** `map(...)` -> <RequestCard />
            โโโ โก๏ธ onOffer() -> ุชุทูู `OfferDialog`

/components/carrier (ููููุงุช ุงูุนูููุงุช)
โ
โโโ request-card.tsx (ูุงุฌูุฉ ุงูุนุฑุถ ูููุฑุตุฉ)
โ   โโโ ูุนุฑุถ ุจูุงูุงุช ุงูุฑุญูุฉ ุงููุทููุจุฉ ูุฒุฑ "ุชูุฏูู ุนุฑุถ".
โ
โโโ offer-dialog.tsx (ุบุฑูุฉ ุตูุงุบุฉ ุงูุนุฑุถ)
    โโโ ๐ง **ุงูููุทู:** `useForm()` ูุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูุนุฑุถ (ุงูุณุนุฑุ ุงูุนููุฉุ ุงูุนุฑุจูู...).
    โโโ ๐ค **ุงูุชูุงูู ูุน ุงูุฐูุงุก ุงูุงุตุทูุงุนู:**
    โ   โโโ ุฒุฑ `onSuggestPrice` -> ูุณุชุฏุนู `/ai/flows/suggest-offer-price-flow.ts`.
    โโโ ๐ **ุงูุฅุฑุณุงู:**
        โโโ `handleSendOffer` -> ุชูุดุฆ ูุซููุฉ ุฌุฏูุฏุฉ ูู `/trips/{tripId}/offers`.

/functions/src/index.ts (ุงูุนูู ุงูุณุญุงุจู)
โ
โโโ onNewOffer (ุฌุณุฑ ุงูุฅุดุนุงุฑุงุช - SC-072)
    โโโ 1. **ุงููุดุบูู:** `onCreate` ุนูู `/trips/{tripId}/offers/{offerId}`.
    โโโ 2. **ุงูุฅุฌุฑุงุก:** ููุฑุฃ ุจูุงูุงุช ุงูุฑุญูุฉ ูุงููุงููุ ุซู ูุฑุณู ุฅุดุนุงุฑุงู ุขููุงู ูููุณุงูุฑ.
```

---

### 2. ุงูุชุญููู ุงูุดูููู (Holistic Analysis)

#### 2.1. ูู "ูุงุฆูุฉ ุบุจูุฉ" ุฅูู "ูุญุฑู ุฐูู"
ุงูุจููุฉ ุงูุญุงููุฉ ุชุชุฌุงูุฒ ููุฑุฉ ุนุฑุถ ูุงุฆูุฉ ุจุณูุทุฉ. ุฅููุง ุนุจุงุฑุฉ ุนู "ูุญุฑู ุงุณุชุนูุงู ูุชุนุฏุฏ ุงูุทุจูุงุช" ูุชุฎุฐ ูุฑุงุฑุงุช ุฏููุงููููุฉ ุจูุงุกู ุนูู ุญุงูุฉ ุงููุงูู:
1.  **ุฅุฐุง ูุงู ูุดุบููุงู:** ูุชุญูู ุงูุณูู ุฅูู "ูููู ููุฌุณุชู" ูุณุงุนุฏู ูู ุชุฃููู ุฑุญูุฉ ุงูุนูุฏุฉ.
2.  **ุฅุฐุง ูุงู ูุชุงุญุงู:** ูุชุญูู ุงูุณูู ุฅูู "ููุชุฑ ุฐูู" ูุนุฑุถ ูู ููุท ุงููุฑุต ุงูุชู ููููู ุฎุฏูุชูุง ุจุงููุนู.

#### 2.2. ุงูุงูุชุซุงู ููุจุฑูุชููููุงุช ุงูุณูุงุฏูุฉ
*   **ุจุฑูุชูููู 88 (ุญูุงูุฉ ุงูููุงุฑุฏ):**
    *   **ุงูููุชุฑุฉ ูุจู ุงูุฌูุจ:** ุฌููุน ุดุฑูุท ุงูููุชุฑุฉ (ุงูุณุนุฉุ ุงูุชูุถููุ ุงูุงุฎุชุตุงุต) ูุชู ุชุทุจูููุง ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (`where(...)`)ุ ููุง ูุถูู ุฃู ุงูุจูุงูุงุช ุงูุชู ูุชู ุฌูุจูุง ูุฌูุงุฒ ุงููุงูู ูู ุงูุญุฏ ุงูุฃุฏูู ุงููุทููุจ. ูุฐุง ูููุน ูุฏุฑ ุงูููุงุฑุฏ ุจุดูู ูุงุทุน.
    *   **ุงูููุฑุณุฉ:** ูุชุทูุจ ูุฐุง ุงููุณุชูู ูู ุงูููุชุฑุฉ ููุฑุงุณุงู ูุฑูุจุฉ (Composite Indexes) ูู Firestoreุ ููู ูุง ูุถูู ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ ุญุชู ูุน ููุงููู ุงูุทูุจุงุช.

*   **ุจุฑูุชูููู 11 (ููุน ุงูุชุถุงุฑุจ):**
    *   ููุทู "ุงูุนูุฏุฉ" ูููุทู "ุงูุงุฎุชุตุงุต" ูุง ูุชุนุงุฑุถุงูุ ุจู ูุนููุงู ุจุชุฑุชูุจ ุฃููููุงุช ูุงุถุญ ููุญุฏุฏุ ููุง ูููุน ุฃู ุญุงูุฉ ุชุถุงุฑุจ.

*   **ุจุฑูุชูููู 16 (ุงูุชุทููุฑ):**
    *   ุชู ุชุนููู ุงูููู `opportunities/page.tsx` ุจุงููุงูู ูู ุงูุฃูุฑ **SC-075**ุ ูุฃุตุจุญ ูููุงู "ุฐูุจูุงู" (Golden Master) ุฎุงููุงู ูู ุฃู ุฏููู ุชูููุฉ.

**ุงูุฎูุงุตุฉ:**
ุดุฌุฑุฉ ุณูู ุงููุฑุต ููุณุช ูุฌุฑุฏ ูุงุฌูุฉุ ุจู ูู ูุธุงู ูุชูุงูู ููุนูุฏ ูุฌูุน ุจูู ููุทู ุงูุนูููุ ูููุฉ ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ูุฐูุงุก ุงูุณุญุงุจุฉ ูุชูุฏูู ุชุฌุฑุจุฉ ูุนุงูุฉุ ุฐููุฉุ ูุงูุชุตุงุฏูุฉ ูู ุงุณุชููุงู ุงูููุงุฑุฏ.

---
*ุชู ุงุนุชูุงุฏ ูุฐู ุงููุซููุฉ ููุฑุฌุน ููุงุฆู ูุจููุฉ ุณูู ุงููุฑุต ูู ูุธุงู ุณูุฑูุงุช.*
